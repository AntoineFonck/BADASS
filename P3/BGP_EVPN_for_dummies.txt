Why not keep using only multicast ?

Security issue with default VXLAN (RFC 7348)

BGP EVPN (RFC 8365)

BGP EVPN (Border Gateway Protocol / Ethernet Virtual Private Network)

First of all, let's define what is an AS (Autonomous System).

An AS is an independent network usually connected to the internet, and defined by an ID (ASN - Autonomous System Number).
AS are usually under the control of companies or organizations.

BGP is a protocol used at internet-scale for routers to exchange routing informations between each other.
eBGP (exterior BGP) is used by routers between two AS
iBGP (interior BGP) is used by routers inside a single AS

When routers use BGP under the same ASN, they automatically use iBGP.

iBGP is usually used to bring the outgoing traffic outside of the AS.

When in iBGP mode, BGP routers act in two interesting ways :
	- They don't redistribute routes that they learned from an other router. This means that for iBGP to work, you would have to interconnect all iBGP routers between each other. A better solution for that is to use RR (Route Reflectors).

Le principe de cette solution est simple : les hôtes hébergeant les VTEP utilisent BGP pour échanger les informations nécessaires au fonctionnement de VXLAN. Un VTEP n'apprend plus les associations {adresse MAC → VTEP} en observant des paquets : il est désormais impossible pour un attaquant d'empoisonner des VTEP simplement en envoyant des paquets VXLAN.
https://connect.ed-diamond.com/MISC/misc-110/securite-de-l-implementation-standard-de-vxlan (FR)
https://vincent.bernat.ch/fr/blog/2017-vxlan-bgp-evpn (FR)

The vulnerability comes from the fact that the VTEP "learns" associations when it receives a packet.

To achieve a large scale VXLAN deployment, the two things main things to keep in mind are :
	- VTEPs need to know easily about other VTEPs sharing the same ID
	- VTEPs need to know about hosts behind remote VTEPs (to avoid network congestion with useless broadcast, unknown unicast or multicast (BUM) packets sent to all/too many VTEPs)) 


BGP EVPN is a solution to avoid :
	- using multicast or hardcoded IPs to reach other VTEPs
	- learning dynamically about hosts behind VTEPs (by analyzing incoming packets)

Why would you want to avoid those two things ?
	- dynamic learning can pose a security risk (what if an attacker sends a fake REAL_SERVER_MAC:ATTACKER_VTEP_IP association to a VTEP)
	- multicast VXLAN causes unnecessary network congestion (each VXLAN packet is sent to all VTEPs that subscribed to the multicast group, instead of only the concerned ones)
	- static VXLAN is probably a nightmare to maintain 

What is BGP EVPN ?

BGP EVPN repose sur BGP (RFC 4271) et ses extensions MP-BGP (RFC 4760). BGP est le protocole de routage animant Internet. Via les extensions MP-BGP, il peut être utilisé pour transporter des informations d’accessibilité (NLRI) pour divers protocoles (IPv4, IPv6, L3 VPN et dans le cas qui nous intéresse, EVPN). EVPN est une famille spéciale permettant de publier des informations sur les adresses MAC et les équipements terminaux y donnant accès.

So how does it work ?

Instead of learning dynamically, VTEPs will use BGP to 

A route reflector (RR) will centralize all the data and distribute it to the VTEPs (called "leafs", in this context)

Route reflectors reflect the routes announced by the peers configured as clients

https://docs.frrouting.org/en/latest/bgp.html

Local MAC addresses will be learned automatically by the VTEP (which is fine)
But remote MAC addresses will be learned via BGP EVPN.

Thanks to BGP EVPN and its RR, the FDB of our VTEPs will synchronize automatically.

We will use OSPF as a routing protocol in our iBGP backbone.

OSPF (Open Shortest Path First), an internal routing protocol, will be used so that our routers swiftly create a BGP 

BGP, through its extensions (called MP-BGP - MultiProtocol extensions for Border Gateway Protocol), can be used to carry 

In our network, BGP-EVPN will be used as our control plane
While VXLAN will be our data plane

Control plane : how our data is routed (BGP-EVPN)
Data plane : what is the data being routed (VXLAN traffic)

NLRI : Network Layer Reachability Information

Natively, BGP-4 (the current version of the BGP protocol) can only carry and relay IPv4 unicast NLRI.

Through its extensions (MP-BGP), it can relay more NLRI (eg IPv6 unicast, IPv4 multicast...).

EVPN uses the MP-BGP extensions to add new available NLRI sharable by BGP --> EVPN NLRI.
The available NLRI are :
	- Host IP address
	- MAC address
	- VNI

This is great for VXLAN !

After a VTEP learns the IP address and MAC address of a connected host, the VTEP can send the information to other VTEPs through MP-BGP routes. In this way, learning of host IP address and MAC address information can be implemented on the control plane, suppressing traffic flooding on the data plane (with multicast).

Using EVPN as the control plane of VXLAN has the following advantages:

	- VTEPs can be automatically discovered and VXLAN tunnels can be automatically established, simplifying network deployment and expansion.
	- EVPN can advertise both Layer 2 MAC address information and Layer 3 routing information.
	- Flooding traffic is reduced on the network.

This also has the added benefit of being more secure.

https://support.huawei.com/enterprise/en/doc/EDOC1100086966/57c6e2cd?idPath=24030814|21782165|21782239|22318540|7597815 (VXLAN)

https://support.huawei.com/enterprise/fr/doc/EDOC1100168670 (BGP-EVPN)

https://support.huawei.com/enterprise/fr/doc/EDOC1100082074 (OSPF)

Using an IGP is recommended with iBGP. Without the IGP, iBGP must neighbor on external-facing interfaces, with an IGP, iBGP can neighbor on loopback interfaces which never go down, and can have multiple paths to reach.

We use OSPF as an IGP.

Why ?

This is mostly the case with iBGP, which is generally configured using the router loopback interface address rather than the directly connected interface address. This is very useful as the BGP session will not go down if the physical interface goes down as long as there is a backup path to the peer router loopback address. The IGP is used to establish the BGP session (TCP session) and to resolve the BGP next hop.

https://www.cisco.com/c/en/us/support/docs/ip/border-gateway-protocol-bgp/200952-Configuration-and-Verification-VXLAN-wit.html

VTEPs use BGP-EVPN to advertise their local hosts, via the route reflector, to other VTEPs
